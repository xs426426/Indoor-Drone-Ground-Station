<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‘„åƒå¤´å®æ—¶è§†é¢‘</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    h1 {
      color: #4fc3f7;
      margin-bottom: 20px;
      font-size: 24px;
    }
    #videoContainer {
      position: relative;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      border: 1px solid #333;
    }
    #videoFrame {
      max-width: 90vw;
      max-height: 70vh;
      display: block;
    }
    #noSignal {
      width: 640px;
      height: 480px;
      max-width: 90vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #666;
      font-size: 16px;
      background: linear-gradient(135deg, #111 0%, #1a1a2e 100%);
    }
    #noSignal .icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }
    #noSignal .text {
      color: #888;
    }
    #noSignal .subtext {
      font-size: 12px;
      color: #555;
      margin-top: 10px;
    }
    #status {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 6px 14px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: bold;
    }
    #status.connected { background: #4caf50; color: #fff; }
    #status.disconnected { background: #f44336; color: #fff; }
    #status.connecting { background: #ff9800; color: #fff; }
    #info {
      position: absolute;
      bottom: 12px;
      left: 12px;
      background: rgba(0,0,0,0.7);
      padding: 10px 14px;
      border-radius: 6px;
      font-size: 12px;
      display: flex;
      gap: 20px;
    }
    #info .item { display: flex; align-items: center; gap: 6px; }
    #info .label { color: #888; }
    #info .value { color: #4fc3f7; font-weight: bold; }
    #controls {
      margin-top: 20px;
      display: flex;
      gap: 12px;
    }
    #controls button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #controls button:hover { transform: scale(1.05); }
    #controls button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    #controls button.primary { background: #4fc3f7; color: #000; }
    #controls button.secondary { background: #333; color: #fff; border: 1px solid #444; }
    #controls button.danger { background: #f44336; color: #fff; }
    #fullscreenBtn {
      position: absolute;
      top: 12px;
      left: 12px;
      background: rgba(0,0,0,0.6);
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    #fullscreenBtn:hover { background: rgba(0,0,0,0.8); }
  </style>
</head>
<body>
  <h1>ğŸ“¹ æ‘„åƒå¤´å®æ—¶è§†é¢‘</h1>

  <div id="videoContainer">
    <div id="noSignal">
      <div class="icon">ğŸ“·</div>
      <div class="text">ç­‰å¾…è§†é¢‘ä¿¡å·...</div>
      <div class="subtext">è¯·ç¡®ä¿æ— äººæœºå·²å¼€å¯å¹¶è¿æ¥</div>
    </div>
    <img id="videoFrame" style="display: none;" alt="Camera Feed">
    <div id="status" class="connecting">è¿æ¥ä¸­...</div>
    <button id="fullscreenBtn">â›¶ å…¨å±</button>
    <div id="info">
      <div class="item"><span class="label">FPS:</span><span class="value" id="fps">0</span></div>
      <div class="item"><span class="label">å¸§æ•°:</span><span class="value" id="frameCount">0</span></div>
      <div class="item"><span class="label">åˆ†è¾¨ç‡:</span><span class="value" id="resolution">-</span></div>
    </div>
  </div>

  <div id="controls">
    <button class="primary" id="pauseBtn">â¸ æš‚åœ</button>
    <button class="secondary" id="screenshotBtn">ğŸ“¸ æˆªå›¾</button>
  </div>

  <script>
    // é…ç½®
    // WebSocketè¿æ¥ï¼šå¦‚æœæ˜¯80ç«¯å£åˆ™ä¸å¸¦ç«¯å£å·ï¼Œå¦åˆ™ä½¿ç”¨å½“å‰ç«¯å£
    const wsPort = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
    const WS_URL = wsPort === '80' || wsPort === '443'
      ? `ws://${window.location.hostname}`
      : `ws://${window.location.hostname}:${wsPort}`;

    // çŠ¶æ€
    let ws = null;
    let isPaused = false;
    let frameCount = 0;
    let fpsFrameCount = 0;

    // å…ƒç´ 
    const videoFrame = document.getElementById('videoFrame');
    const noSignal = document.getElementById('noSignal');
    const statusEl = document.getElementById('status');
    const fpsEl = document.getElementById('fps');
    const frameCountEl = document.getElementById('frameCount');
    const resolutionEl = document.getElementById('resolution');

    // WebSocket è¿æ¥
    function connectWebSocket() {
      console.log('ğŸ”— è¿æ¥ WebSocket:', WS_URL);
      statusEl.className = 'connecting';
      statusEl.textContent = 'è¿æ¥ä¸­...';

      try {
        ws = new WebSocket(WS_URL);

        ws.onopen = () => {
          statusEl.className = 'connected';
          statusEl.textContent = 'å·²è¿æ¥';
          console.log('âœ… WebSocket å·²è¿æ¥');
        };

        ws.onclose = () => {
          statusEl.className = 'disconnected';
          statusEl.textContent = 'å·²æ–­å¼€';
          console.log('âŒ WebSocket å·²æ–­å¼€ï¼Œ5ç§’åé‡è¿...');
          setTimeout(connectWebSocket, 5000);
        };

        ws.onerror = (err) => {
          console.error('âŒ WebSocket é”™è¯¯:', err);
          statusEl.className = 'disconnected';
          statusEl.textContent = 'è¿æ¥é”™è¯¯';
        };

        ws.onmessage = (event) => {
          try {
            const msg = JSON.parse(event.data);
            handleMessage(msg);
          } catch (e) {
            console.error('æ¶ˆæ¯è§£æé”™è¯¯:', e);
          }
        };
      } catch (error) {
        console.error('âŒ WebSocket åˆ›å»ºå¤±è´¥:', error);
        statusEl.className = 'disconnected';
        statusEl.textContent = 'è¿æ¥å¤±è´¥';
        setTimeout(connectWebSocket, 5000);
      }
    }

    function handleMessage(msg) {
      if (msg.type === 'mqtt_message' && msg.topic === '/daf/camera' && !isPaused) {
        const data = msg.data;
        if (data && data.data) {
          displayFrame(data);
        }
      }
    }

    function displayFrame(data) {
      // æ„å»ºå›¾ç‰‡URL
      let imgSrc;
      const encoding = data.encoding || 'jpeg';

      if (encoding === 'jpeg' || encoding === 'png') {
        imgSrc = `data:image/${encoding};base64,${data.data}`;
      } else {
        imgSrc = `data:image/jpeg;base64,${data.data}`;
      }

      // æ˜¾ç¤ºå›¾ç‰‡
      videoFrame.src = imgSrc;
      videoFrame.style.display = 'block';
      noSignal.style.display = 'none';

      // æ›´æ–°ç»Ÿè®¡
      frameCount++;
      frameCountEl.textContent = frameCount;
      fpsFrameCount++;

      // è·å–åˆ†è¾¨ç‡
      videoFrame.onload = () => {
        resolutionEl.textContent = `${videoFrame.naturalWidth}x${videoFrame.naturalHeight}`;
      };
    }

    // FPS è®¡ç®—
    setInterval(() => {
      fpsEl.textContent = fpsFrameCount;
      fpsFrameCount = 0;
    }, 1000);

    // æš‚åœ/ç»§ç»­
    document.getElementById('pauseBtn').addEventListener('click', function() {
      isPaused = !isPaused;
      this.textContent = isPaused ? 'â–¶ ç»§ç»­' : 'â¸ æš‚åœ';
      this.className = isPaused ? 'danger' : 'primary';

      if (isPaused && videoFrame.style.display === 'none') {
        noSignal.querySelector('.text').textContent = 'å·²æš‚åœ';
      } else if (!isPaused && videoFrame.style.display === 'none') {
        noSignal.querySelector('.text').textContent = 'ç­‰å¾…è§†é¢‘ä¿¡å·...';
      }

      console.log(isPaused ? 'â¸ å·²æš‚åœ' : 'â–¶ å·²ç»§ç»­');
    });

    // æˆªå›¾
    document.getElementById('screenshotBtn').addEventListener('click', () => {
      if (videoFrame.style.display === 'none') {
        alert('æš‚æ— è§†é¢‘ç”»é¢');
        return;
      }

      // åˆ›å»ºCanvas
      const canvas = document.createElement('canvas');
      canvas.width = videoFrame.naturalWidth;
      canvas.height = videoFrame.naturalHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(videoFrame, 0, 0);

      // ä¸‹è½½
      const link = document.createElement('a');
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
      link.download = `screenshot_${timestamp}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();

      console.log('ğŸ“¸ æˆªå›¾å·²ä¿å­˜');
    });

    // å…¨å±
    document.getElementById('fullscreenBtn').addEventListener('click', () => {
      const container = document.getElementById('videoContainer');
      if (container.requestFullscreen) {
        container.requestFullscreen();
      } else if (container.webkitRequestFullscreen) {
        container.webkitRequestFullscreen();
      }
    });

    // åˆå§‹åŒ–
    connectWebSocket();
  </script>
</body>
</html>
