<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç‚¹äº‘å®æ—¶æ˜¾ç¤º</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0d1117;
      color: #e6edf3;
      overflow: hidden;
    }
    #container { width: 100vw; height: 100vh; }

    /* é¡¶éƒ¨å·¥å…·æ  */
    #toolbar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 50px;
      background: rgba(22, 27, 34, 0.95);
      border-bottom: 1px solid #30363d;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      z-index: 100;
    }
    #toolbar .left { display: flex; align-items: center; gap: 16px; }
    #toolbar .title {
      font-size: 16px;
      font-weight: 600;
      color: #58a6ff;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #toolbar .right { display: flex; align-items: center; gap: 12px; }

    /* æŒ‰é’®æ ·å¼ */
    .btn {
      padding: 6px 12px;
      border: 1px solid #30363d;
      border-radius: 6px;
      background: #21262d;
      color: #c9d1d9;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
    }
    .btn:hover { background: #30363d; border-color: #8b949e; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn.primary { background: #238636; border-color: #238636; color: #fff; }
    .btn.primary:hover { background: #2ea043; }
    .btn.danger { background: #da3633; border-color: #da3633; color: #fff; }
    .btn.danger:hover { background: #f85149; }
    .btn.active { background: #1f6feb; border-color: #1f6feb; color: #fff; }

    /* è¿æ¥çŠ¶æ€ */
    #status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    #status.connected { background: #238636; color: #fff; }
    #status.disconnected { background: #da3633; color: #fff; }
    #status.connecting { background: #9e6a03; color: #fff; }

    /* å·¦ä¾§ä¿¡æ¯é¢æ¿ */
    #infoPanel {
      position: absolute;
      top: 60px;
      left: 10px;
      width: 200px;
      background: rgba(22, 27, 34, 0.92);
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 12px;
      z-index: 90;
    }
    #infoPanel h4 {
      font-size: 12px;
      color: #8b949e;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #21262d;
      font-size: 13px;
    }
    .stat-row:last-child { border-bottom: none; }
    .stat-row .label { color: #8b949e; }
    .stat-row .value { color: #58a6ff; font-weight: 600; font-family: monospace; }

    /* å³ä¾§æ§åˆ¶é¢æ¿ */
    #controlPanel {
      position: absolute;
      top: 60px;
      right: 10px;
      width: 180px;
      background: rgba(22, 27, 34, 0.92);
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 12px;
      z-index: 90;
    }
    #controlPanel h4 {
      font-size: 12px;
      color: #8b949e;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    #controlPanel .control-group {
      margin-bottom: 12px;
    }
    #controlPanel .control-group:last-child { margin-bottom: 0; }
    #controlPanel label {
      display: block;
      font-size: 11px;
      color: #8b949e;
      margin-bottom: 4px;
    }
    #controlPanel input[type="range"] {
      width: 100%;
      height: 4px;
      background: #30363d;
      border-radius: 2px;
      outline: none;
      -webkit-appearance: none;
    }
    #controlPanel input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      background: #58a6ff;
      border-radius: 50%;
      cursor: pointer;
    }
    #controlPanel .range-value {
      font-size: 11px;
      color: #58a6ff;
      text-align: right;
      margin-top: 2px;
    }
    #controlPanel .btn-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #controlPanel .btn { width: 100%; justify-content: center; }

    /* åº•éƒ¨æç¤º */
    #hint {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(22, 27, 34, 0.9);
      border: 1px solid #30363d;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      color: #8b949e;
      display: flex;
      gap: 20px;
      z-index: 90;
    }
    #hint span { display: flex; align-items: center; gap: 4px; }

    /* åŠ è½½åŠ¨ç”» */
    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 200;
    }
    #loading.hidden { display: none; }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #30363d;
      border-top-color: #58a6ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* æ–‡ä»¶ä¸Šä¼ éšè— */
    #fileInput { display: none; }
  </style>
</head>
<body>
  <div id="container"></div>

  <div id="loading">
    <div class="spinner"></div>
    <div>æ­£åœ¨åŠ è½½3Dåœºæ™¯...</div>
  </div>

  <!-- é¡¶éƒ¨å·¥å…·æ  -->
  <div id="toolbar">
    <div class="left">
      <div class="title">
        <span>â˜ï¸</span>
        <span>ç‚¹äº‘å®æ—¶æ˜¾ç¤º</span>
      </div>
      <div id="status" class="connecting">è¿æ¥ä¸­...</div>
    </div>
    <div class="right">
      <input type="file" id="fileInput" accept=".pcd">
      <button class="btn" id="loadBtn" title="åŠ è½½æœ¬åœ°PCDæ–‡ä»¶">
        <span>ğŸ“‚</span> åŠ è½½ç‚¹äº‘
      </button>
      <button class="btn primary" id="saveBtn" title="ä¿å­˜å½“å‰ç‚¹äº‘ä¸ºPCDæ–‡ä»¶" disabled>
        <span>ğŸ’¾</span> ä¿å­˜ç‚¹äº‘
      </button>
      <button class="btn" id="pauseBtn" title="æš‚åœ/ç»§ç»­æ¥æ”¶æ•°æ®">
        <span>â¸</span> æš‚åœ
      </button>
      <button class="btn danger" id="clearBtn" title="æ¸…ç©ºæ‰€æœ‰ç‚¹äº‘æ•°æ®">
        <span>ğŸ—‘</span> æ¸…ç©º
      </button>
    </div>
  </div>

  <!-- å·¦ä¾§ä¿¡æ¯é¢æ¿ -->
  <div id="infoPanel">
    <h4>ğŸ“Š æ•°æ®ç»Ÿè®¡</h4>
    <div class="stat-row">
      <span class="label">æ€»ç‚¹æ•°</span>
      <span class="value" id="totalPoints">0</span>
    </div>
    <div class="stat-row">
      <span class="label">ç´¯è®¡å¸§æ•°</span>
      <span class="value" id="frameCount">0</span>
    </div>
    <div class="stat-row">
      <span class="label">æ¸²æŸ“FPS</span>
      <span class="value" id="fps">0</span>
    </div>
    <div class="stat-row">
      <span class="label">æ— äººæœºä½ç½®</span>
      <span class="value" id="dronePos">--</span>
    </div>
    <div class="stat-row">
      <span class="label">æ–‡ä»¶</span>
      <span class="value" id="fileName">æ— </span>
    </div>
  </div>

  <!-- å³ä¾§æ§åˆ¶é¢æ¿ -->
  <div id="controlPanel">
    <h4>âš™ï¸ æ˜¾ç¤ºè®¾ç½®</h4>
    <div class="control-group">
      <label>ç‚¹å¤§å°</label>
      <input type="range" id="pointSize" min="1" max="10" value="3" step="0.5">
      <div class="range-value" id="pointSizeValue">0.03</div>
    </div>
    <div class="control-group">
      <label>æœ€å¤§ç‚¹æ•° (ä¸‡)</label>
      <input type="range" id="maxPoints" min="5" max="100" value="50" step="5">
      <div class="range-value" id="maxPointsValue">50ä¸‡</div>
    </div>
    <div class="control-group">
      <h4 style="margin-top: 8px;">ğŸ“· è§†è§’</h4>
      <div class="btn-group">
        <button class="btn" id="viewTop">ä¿¯è§†å›¾</button>
        <button class="btn" id="viewFront">æ­£è§†å›¾</button>
        <button class="btn" id="viewSide">ä¾§è§†å›¾</button>
        <button class="btn" id="viewReset">é‡ç½®è§†è§’</button>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨æç¤º -->
  <div id="hint">
    <span>ğŸ–±ï¸ å·¦é”®æ—‹è½¬</span>
    <span>ğŸ–±ï¸ å³é”®å¹³ç§»</span>
    <span>ğŸ–±ï¸ æ»šè½®ç¼©æ”¾</span>
  </div>

  <!-- Three.js - ä½¿ç”¨cdnjsæ›´ç¨³å®š -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    // OrbitControls å†…è”ä»£ç ï¼ˆé¿å…è·¨åŸŸé—®é¢˜ï¼‰
    THREE.OrbitControls = function(object, domElement) {
      this.object = object;
      this.domElement = domElement;
      this.target = new THREE.Vector3();
      this.enableDamping = true;  // å¼€å¯é˜»å°¼ï¼ˆæƒ¯æ€§ï¼‰ï¼Œä¸ä¸»ç½‘ç«™ä¸€è‡´
      this.dampingFactor = 0.05;
      this.enableZoom = true;
      this.enableRotate = true;
      this.enablePan = true;
      this.rotateSpeed = 0.5;     // ä¸ä¸»ç½‘ç«™ä¸€è‡´
      this.zoomSpeed = 0.8;       // ä¸ä¸»ç½‘ç«™ä¸€è‡´
      this.panSpeed = 1.0;

      var scope = this;
      var spherical = new THREE.Spherical();
      var sphericalDelta = new THREE.Spherical();
      var scale = 1;
      var panOffset = new THREE.Vector3();
      var rotateStart = new THREE.Vector2();
      var rotateEnd = new THREE.Vector2();
      var rotateDelta = new THREE.Vector2();
      var panStart = new THREE.Vector2();
      var panEnd = new THREE.Vector2();
      var panDelta = new THREE.Vector2();
      var STATE = { NONE: -1, ROTATE: 0, ZOOM: 1, PAN: 2 };
      var state = STATE.NONE;

      // ç¼©æ”¾çµæ•åº¦ï¼Œä¸ä¸»ç½‘ç«™ä¸€è‡´ (zoomSpeed=0.8)
      function getZoomScale() { return Math.pow(0.95, scope.zoomSpeed); }

      function rotateLeft(angle) { sphericalDelta.theta -= angle; }
      function rotateUp(angle) { sphericalDelta.phi -= angle; }

      function panLeft(distance, objectMatrix) {
        var v = new THREE.Vector3();
        v.setFromMatrixColumn(objectMatrix, 0);
        v.multiplyScalar(-distance);
        panOffset.add(v);
      }

      function panUp(distance, objectMatrix) {
        var v = new THREE.Vector3();
        v.setFromMatrixColumn(objectMatrix, 1);
        v.multiplyScalar(distance);
        panOffset.add(v);
      }

      function pan(deltaX, deltaY) {
        var element = scope.domElement;
        var position = scope.object.position;
        var offset = position.clone().sub(scope.target);
        var targetDistance = offset.length();
        targetDistance *= Math.tan((scope.object.fov / 2) * Math.PI / 180.0);
        panLeft(2 * deltaX * targetDistance / element.clientHeight, scope.object.matrix);
        panUp(2 * deltaY * targetDistance / element.clientHeight, scope.object.matrix);
      }

      this.update = function() {
        var offset = new THREE.Vector3();
        var quat = new THREE.Quaternion().setFromUnitVectors(object.up, new THREE.Vector3(0, 1, 0));
        var quatInverse = quat.clone().invert();
        var position = scope.object.position;

        offset.copy(position).sub(scope.target);
        offset.applyQuaternion(quat);
        spherical.setFromVector3(offset);
        spherical.theta += sphericalDelta.theta;
        spherical.phi += sphericalDelta.phi;
        spherical.phi = Math.max(0.01, Math.min(Math.PI - 0.01, spherical.phi));
        spherical.radius *= scale;
        spherical.radius = Math.max(0.1, Math.min(1000, spherical.radius));

        scope.target.add(panOffset);
        offset.setFromSpherical(spherical);
        offset.applyQuaternion(quatInverse);
        position.copy(scope.target).add(offset);
        scope.object.lookAt(scope.target);

        if (scope.enableDamping) {
          sphericalDelta.theta *= (1 - scope.dampingFactor);
          sphericalDelta.phi *= (1 - scope.dampingFactor);
        } else {
          sphericalDelta.set(0, 0, 0);
        }
        scale = 1;
        panOffset.set(0, 0, 0);
        return false;
      };

      function onMouseDown(event) {
        event.preventDefault();
        if (event.button === 0) {
          state = STATE.ROTATE;
          rotateStart.set(event.clientX, event.clientY);
        } else if (event.button === 2) {
          state = STATE.PAN;
          panStart.set(event.clientX, event.clientY);
        }
        document.addEventListener('mousemove', onMouseMove, false);
        document.addEventListener('mouseup', onMouseUp, false);
      }

      function onMouseMove(event) {
        event.preventDefault();
        if (state === STATE.ROTATE) {
          rotateEnd.set(event.clientX, event.clientY);
          rotateDelta.subVectors(rotateEnd, rotateStart);
          // æ—‹è½¬çµæ•åº¦ï¼Œä¸ä¸»ç½‘ç«™ä¸€è‡´ (rotateSpeed=0.5)
          rotateLeft(2 * Math.PI * rotateDelta.x / domElement.clientWidth * scope.rotateSpeed);
          rotateUp(2 * Math.PI * rotateDelta.y / domElement.clientHeight * scope.rotateSpeed);
          rotateStart.copy(rotateEnd);
        } else if (state === STATE.PAN) {
          panEnd.set(event.clientX, event.clientY);
          panDelta.subVectors(panEnd, panStart);
          // å¹³ç§»çµæ•åº¦ï¼Œä¸ä¸»ç½‘ç«™ä¸€è‡´
          pan(panDelta.x * scope.panSpeed, panDelta.y * scope.panSpeed);
          panStart.copy(panEnd);
        }
        scope.update();
      }

      function onMouseUp() {
        state = STATE.NONE;
        document.removeEventListener('mousemove', onMouseMove, false);
        document.removeEventListener('mouseup', onMouseUp, false);
      }

      function onWheel(event) {
        event.preventDefault();
        if (event.deltaY < 0) { scale /= getZoomScale(); }
        else if (event.deltaY > 0) { scale *= getZoomScale(); }
        scope.update();
      }

      function onContextMenu(event) { event.preventDefault(); }

      domElement.addEventListener('mousedown', onMouseDown, false);
      domElement.addEventListener('wheel', onWheel, { passive: false });
      domElement.addEventListener('contextmenu', onContextMenu, false);

      this.update();
    };
  </script>

  <script>
    // ==================== é…ç½® ====================
    // WebSocketè¿æ¥ï¼šå¦‚æœæ˜¯80ç«¯å£åˆ™ä¸å¸¦ç«¯å£å·ï¼Œå¦åˆ™ä½¿ç”¨å½“å‰ç«¯å£
    const wsPort = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
    const WS_URL = wsPort === '80' || wsPort === '443'
      ? `ws://${window.location.hostname}`
      : `ws://${window.location.hostname}:${wsPort}`;
    let MAX_POINTS = 500000;

    // ==================== çŠ¶æ€ ====================
    let ws = null;
    let isPaused = false;
    let totalPoints = 0;
    let frameCount = 0;
    let lastFpsTime = Date.now();
    let fpsFrameCount = 0;
    let loadedFileName = null;

    // ==================== Three.js ====================
    let scene, camera, renderer, controls;
    let pointCloud, pointGeometry, pointMaterial;
    let droneModel;
    let positions = [];
    let colors = [];

    // ==================== åˆå§‹åŒ– Three.js ====================
    function initThree() {
      try {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0d1117);

        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(8, 8, 8);
        camera.up.set(0, 0, 1);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('container').appendChild(renderer.domElement);

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.target.set(0, 0, 0);

        // ç¯å…‰
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(10, 10, 10);
        scene.add(dirLight);

        // ç½‘æ ¼
        const gridHelper = new THREE.GridHelper(20, 20, 0x58a6ff, 0x21262d);
        gridHelper.rotation.x = Math.PI / 2;
        scene.add(gridHelper);

        // åæ ‡è½´
        scene.add(new THREE.AxesHelper(3));
        addAxisLabels();

        // ç‚¹äº‘
        pointGeometry = new THREE.BufferGeometry();
        pointMaterial = new THREE.PointsMaterial({
          size: 0.03,
          vertexColors: true,
          sizeAttenuation: true
        });
        pointCloud = new THREE.Points(pointGeometry, pointMaterial);
        scene.add(pointCloud);

        // æ— äººæœºæ¨¡å‹
        createDroneModel();

        window.addEventListener('resize', onWindowResize);
        document.getElementById('loading').classList.add('hidden');
        animate();
        console.log('âœ… 3Dåœºæ™¯åˆå§‹åŒ–æˆåŠŸ');
      } catch (error) {
        console.error('âŒ 3Dåœºæ™¯åˆå§‹åŒ–å¤±è´¥:', error);
        document.getElementById('loading').innerHTML = '<div style="color: #f85149;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
      }
    }

    function addAxisLabels() {
      const createLabel = (text, position, color) => {
        const canvas = document.createElement('canvas');
        canvas.width = 64;
        canvas.height = 64;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = color;
        ctx.font = 'bold 48px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(text, 32, 32);
        const texture = new THREE.CanvasTexture(canvas);
        const material = new THREE.SpriteMaterial({ map: texture });
        const sprite = new THREE.Sprite(material);
        sprite.position.copy(position);
        sprite.scale.set(0.5, 0.5, 0.5);
        scene.add(sprite);
      };
      createLabel('X', new THREE.Vector3(3.5, 0, 0), '#f85149');
      createLabel('Y', new THREE.Vector3(0, 3.5, 0), '#3fb950');
      createLabel('Z', new THREE.Vector3(0, 0, 3.5), '#58a6ff');
    }

    function createDroneModel() {
      droneModel = new THREE.Group();
      const bodyGeom = new THREE.BoxGeometry(0.3, 0.3, 0.08);
      const bodyMat = new THREE.MeshStandardMaterial({ color: 0x58a6ff, metalness: 0.8, roughness: 0.2 });
      droneModel.add(new THREE.Mesh(bodyGeom, bodyMat));

      const coneGeom = new THREE.ConeGeometry(0.04, 0.12, 4);
      const coneMat = new THREE.MeshStandardMaterial({ color: 0xf85149, emissive: 0xf85149, emissiveIntensity: 0.5 });
      const cone = new THREE.Mesh(coneGeom, coneMat);
      cone.position.set(0.2, 0, 0);
      cone.rotation.z = -Math.PI / 2;
      droneModel.add(cone);

      const propGeom = new THREE.CylinderGeometry(0.08, 0.08, 0.01, 32);
      const propMat = new THREE.MeshStandardMaterial({ color: 0x3fb950, transparent: true, opacity: 0.6 });
      [[-0.12, -0.12], [0.12, -0.12], [-0.12, 0.12], [0.12, 0.12]].forEach(([x, y]) => {
        const prop = new THREE.Mesh(propGeom, propMat);
        prop.position.set(x, y, 0.05);
        droneModel.add(prop);
      });

      droneModel.position.set(0, 0, 0);
      scene.add(droneModel);
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
      fpsFrameCount++;
      const now = Date.now();
      if (now - lastFpsTime >= 1000) {
        document.getElementById('fps').textContent = fpsFrameCount;
        fpsFrameCount = 0;
        lastFpsTime = now;
      }
    }

    // ==================== WebSocket ====================
    function connectWebSocket() {
      console.log('ğŸ”— è¿æ¥:', WS_URL);
      updateStatus('connecting', 'è¿æ¥ä¸­...');

      try {
        ws = new WebSocket(WS_URL);
        ws.onopen = () => {
          updateStatus('connected', 'å·²è¿æ¥');
          console.log('âœ… WebSocket å·²è¿æ¥');
        };
        ws.onclose = () => {
          updateStatus('disconnected', 'å·²æ–­å¼€');
          console.log('âŒ å·²æ–­å¼€ï¼Œ5ç§’åé‡è¿...');
          setTimeout(connectWebSocket, 5000);
        };
        ws.onerror = (err) => {
          console.error('âŒ WebSocket é”™è¯¯:', err);
          updateStatus('disconnected', 'è¿æ¥é”™è¯¯');
        };
        ws.onmessage = (event) => {
          try {
            handleMessage(JSON.parse(event.data));
          } catch (e) {
            console.error('æ¶ˆæ¯è§£æé”™è¯¯:', e);
          }
        };
      } catch (error) {
        console.error('âŒ WebSocket åˆ›å»ºå¤±è´¥:', error);
        updateStatus('disconnected', 'è¿æ¥å¤±è´¥');
        setTimeout(connectWebSocket, 5000);
      }
    }

    function updateStatus(className, text) {
      const el = document.getElementById('status');
      el.className = className;
      el.textContent = text;
    }

    function handleMessage(msg) {
      if (msg.type === 'mqtt_message') {
        const { topic, data } = msg;
        if ((topic === '/daf/pointcloud' || topic === '/daf/pointcloud_rgb') && !isPaused) {
          if (data.points && data.points.length > 0) {
            addPoints(data.points);
            frameCount++;
            document.getElementById('frameCount').textContent = frameCount;
          }
        }
        if (topic === '/daf/local/odometry') {
          updateDronePosition(data);
        }
      }
    }

    // ==================== ç‚¹äº‘æ“ä½œ ====================
    function addPoints(newPoints) {
      if (totalPoints >= MAX_POINTS) return;

      const availableSpace = MAX_POINTS - totalPoints;
      const pointsToAdd = newPoints.slice(0, availableSpace);

      pointsToAdd.forEach(point => {
        const x = point.xyz?.x ?? 0;
        const y = point.xyz?.y ?? 0;
        const z = point.xyz?.z ?? 0;
        const intensity = (point.intensity ?? 128) / 255;
        positions.push(x, y, z);
        colors.push(intensity, 0.4, 1 - intensity);
      });

      totalPoints += pointsToAdd.length;
      updatePointCloud();
      updateSaveButton();
    }

    function updatePointCloud() {
      pointGeometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
      pointGeometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
      pointGeometry.computeBoundingSphere();
      document.getElementById('totalPoints').textContent = totalPoints.toLocaleString();
    }

    function clearPoints() {
      positions = [];
      colors = [];
      totalPoints = 0;
      frameCount = 0;
      loadedFileName = null;
      pointGeometry.setAttribute('position', new THREE.Float32BufferAttribute([], 3));
      pointGeometry.setAttribute('color', new THREE.Float32BufferAttribute([], 3));
      document.getElementById('totalPoints').textContent = '0';
      document.getElementById('frameCount').textContent = '0';
      document.getElementById('fileName').textContent = 'æ— ';
      updateSaveButton();
      console.log('ğŸ—‘ ç‚¹äº‘å·²æ¸…ç©º');
    }

    function updateDronePosition(data) {
      const pos = data.pose?.position || data.position;
      const ori = data.pose?.orientation || data.orientation;
      if (pos && droneModel) {
        droneModel.position.set(pos.x, pos.y, pos.z);
        document.getElementById('dronePos').textContent = `${pos.x.toFixed(1)},${pos.y.toFixed(1)},${pos.z.toFixed(1)}`;
      }
      if (ori && droneModel) {
        droneModel.setRotationFromQuaternion(new THREE.Quaternion(ori.x, ori.y, ori.z, ori.w));
      }
    }

    function updateSaveButton() {
      document.getElementById('saveBtn').disabled = totalPoints === 0;
    }

    // ==================== æ–‡ä»¶æ“ä½œ ====================
    function loadPCDFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const text = e.target.result;
          const lines = text.split('\n');
          let dataStarted = false;
          let loadedPoints = [];

          for (let line of lines) {
            line = line.trim();
            if (line.startsWith('DATA')) {
              dataStarted = true;
              continue;
            }
            if (dataStarted && line) {
              const parts = line.split(/\s+/);
              if (parts.length >= 3) {
                const x = parseFloat(parts[0]);
                const y = parseFloat(parts[1]);
                const z = parseFloat(parts[2]);
                const intensity = parts.length >= 4 ? parseInt(parts[3]) & 0xFF : 128;
                if (!isNaN(x) && !isNaN(y) && !isNaN(z)) {
                  loadedPoints.push({ x, y, z, intensity });
                }
              }
            }
          }

          if (loadedPoints.length > 0) {
            // æ¸…ç©ºç°æœ‰æ•°æ®
            positions = [];
            colors = [];
            totalPoints = 0;

            // æ·»åŠ åŠ è½½çš„ç‚¹
            loadedPoints.forEach(p => {
              positions.push(p.x, p.y, p.z);
              const i = p.intensity / 255;
              colors.push(i, 0.4, 1 - i);
            });
            totalPoints = loadedPoints.length;

            updatePointCloud();
            updateSaveButton();
            loadedFileName = file.name;
            document.getElementById('fileName').textContent = file.name.slice(0, 12) + (file.name.length > 12 ? '...' : '');
            console.log(`âœ… å·²åŠ è½½ ${totalPoints.toLocaleString()} ä¸ªç‚¹`);
          }
        } catch (err) {
          console.error('âŒ åŠ è½½å¤±è´¥:', err);
          alert('æ–‡ä»¶åŠ è½½å¤±è´¥: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    function savePCDFile() {
      if (totalPoints === 0) {
        alert('æ²¡æœ‰å¯ä¿å­˜çš„ç‚¹äº‘æ•°æ®');
        return;
      }

      const header = [
        '# .PCD v0.7 - Point Cloud Data file format',
        'VERSION 0.7',
        'FIELDS x y z intensity',
        'SIZE 4 4 4 4',
        'TYPE F F F U',
        'COUNT 1 1 1 1',
        `WIDTH ${totalPoints}`,
        'HEIGHT 1',
        'VIEWPOINT 0 0 0 1 0 0 0',
        `POINTS ${totalPoints}`,
        'DATA ascii'
      ].join('\n');

      let data = '';
      for (let i = 0; i < totalPoints; i++) {
        const idx = i * 3;
        const x = positions[idx];
        const y = positions[idx + 1];
        const z = positions[idx + 2];
        const intensity = Math.floor(colors[idx] * 255);
        data += `${x.toFixed(6)} ${y.toFixed(6)} ${z.toFixed(6)} ${intensity}\n`;
      }

      const blob = new Blob([header + '\n' + data], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
      link.download = `pointcloud_${timestamp}.pcd`;
      link.href = url;
      link.click();
      URL.revokeObjectURL(url);
      console.log(`ğŸ’¾ å·²ä¿å­˜ ${totalPoints.toLocaleString()} ä¸ªç‚¹`);
    }

    // ==================== è§†è§’æ§åˆ¶ ====================
    function setView(position, target) {
      camera.position.set(...position);
      controls.target.set(...target);
      controls.update();
    }

    // ==================== äº‹ä»¶ç»‘å®š ====================
    document.getElementById('loadBtn').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', (e) => {
      if (e.target.files[0]) {
        loadPCDFile(e.target.files[0]);
        e.target.value = '';
      }
    });

    document.getElementById('saveBtn').addEventListener('click', savePCDFile);

    document.getElementById('pauseBtn').addEventListener('click', function() {
      isPaused = !isPaused;
      this.innerHTML = isPaused ? '<span>â–¶</span> ç»§ç»­' : '<span>â¸</span> æš‚åœ';
      this.classList.toggle('active', isPaused);
    });

    document.getElementById('clearBtn').addEventListener('click', clearPoints);

    document.getElementById('pointSize').addEventListener('input', function() {
      const size = this.value / 100;
      pointMaterial.size = size;
      document.getElementById('pointSizeValue').textContent = size.toFixed(2);
    });

    document.getElementById('maxPoints').addEventListener('input', function() {
      MAX_POINTS = this.value * 10000;
      document.getElementById('maxPointsValue').textContent = this.value + 'ä¸‡';
    });

    document.getElementById('viewTop').addEventListener('click', () => setView([0, 0, 15], [0, 0, 0]));
    document.getElementById('viewFront').addEventListener('click', () => setView([15, 0, 2], [0, 0, 2]));
    document.getElementById('viewSide').addEventListener('click', () => setView([0, 15, 2], [0, 0, 2]));
    document.getElementById('viewReset').addEventListener('click', () => setView([8, 8, 8], [0, 0, 0]));

    // ==================== åˆå§‹åŒ– ====================
    window.onload = function() {
      initThree();
      connectWebSocket();
    };
  </script>
</body>
</html>
