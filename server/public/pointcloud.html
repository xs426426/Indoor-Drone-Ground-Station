<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>点云实时显示</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #fff;
      overflow: hidden;
    }
    #container { width: 100vw; height: 100vh; }
    #info {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      padding: 15px 20px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 100;
      min-width: 200px;
    }
    #info h3 { margin-bottom: 10px; color: #4fc3f7; }
    #info .stat { margin: 5px 0; }
    #info .label { color: #888; }
    #info .value { color: #4fc3f7; font-weight: bold; }
    #status {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      z-index: 100;
    }
    #status.connected { background: #4caf50; }
    #status.disconnected { background: #f44336; }
    #controls {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      padding: 15px;
      border-radius: 8px;
      z-index: 100;
    }
    #controls button {
      padding: 8px 16px;
      margin: 0 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    #controls button.primary { background: #4fc3f7; color: #000; }
    #controls button.danger { background: #f44336; color: #fff; }
    #controls button:hover { opacity: 0.8; }
  </style>
</head>
<body>
  <div id="container"></div>

  <div id="info">
    <h3>点云实时显示</h3>
    <div class="stat"><span class="label">总点数: </span><span class="value" id="totalPoints">0</span></div>
    <div class="stat"><span class="label">帧数: </span><span class="value" id="frameCount">0</span></div>
    <div class="stat"><span class="label">FPS: </span><span class="value" id="fps">0</span></div>
    <div class="stat"><span class="label">无人机位置: </span><span class="value" id="dronePos">-</span></div>
  </div>

  <div id="status" class="disconnected">未连接</div>

  <div id="controls">
    <button class="primary" id="pauseBtn">暂停</button>
    <button class="danger" id="clearBtn">清空</button>
  </div>

  <!-- Three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>

  <script>
    // 配置
    const WS_URL = `ws://${window.location.host}`;
    const MAX_POINTS = 500000;

    // 状态
    let ws = null;
    let isPaused = false;
    let totalPoints = 0;
    let frameCount = 0;
    let lastFpsTime = Date.now();
    let fpsFrameCount = 0;

    // Three.js 场景
    let scene, camera, renderer, controls;
    let pointCloud, pointGeometry;
    let droneModel;
    let positions = [];
    let colors = [];

    // 初始化 Three.js
    function initThree() {
      // 场景
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x1a1a2e);

      // 相机
      camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(5, 5, 5);
      camera.up.set(0, 0, 1);

      // 渲染器
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.getElementById('container').appendChild(renderer.domElement);

      // 控制器
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;

      // 灯光
      scene.add(new THREE.AmbientLight(0xffffff, 0.6));
      const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
      dirLight.position.set(10, 10, 10);
      scene.add(dirLight);

      // 网格
      const gridHelper = new THREE.GridHelper(20, 20, 0x4fc3f7, 0x333333);
      gridHelper.rotation.x = Math.PI / 2;
      scene.add(gridHelper);

      // 坐标轴
      scene.add(new THREE.AxesHelper(2));

      // 点云几何体
      pointGeometry = new THREE.BufferGeometry();
      const material = new THREE.PointsMaterial({
        size: 0.03,
        vertexColors: true,
        sizeAttenuation: true
      });
      pointCloud = new THREE.Points(pointGeometry, material);
      scene.add(pointCloud);

      // 无人机模型
      createDroneModel();

      // 窗口调整
      window.addEventListener('resize', onWindowResize);

      // 渲染循环
      animate();
    }

    function createDroneModel() {
      droneModel = new THREE.Group();

      // 主体
      const bodyGeom = new THREE.BoxGeometry(0.3, 0.3, 0.08);
      const bodyMat = new THREE.MeshStandardMaterial({ color: 0x4fc3f7, metalness: 0.8 });
      droneModel.add(new THREE.Mesh(bodyGeom, bodyMat));

      // 前方指示器
      const coneGeom = new THREE.ConeGeometry(0.04, 0.12, 4);
      const coneMat = new THREE.MeshStandardMaterial({ color: 0xff4d4f, emissive: 0xff4d4f, emissiveIntensity: 0.5 });
      const cone = new THREE.Mesh(coneGeom, coneMat);
      cone.position.set(0.2, 0, 0);
      cone.rotation.z = -Math.PI / 2;
      droneModel.add(cone);

      // 螺旋桨
      const propGeom = new THREE.CylinderGeometry(0.08, 0.08, 0.01, 32);
      const propMat = new THREE.MeshStandardMaterial({ color: 0x52c41a, transparent: true, opacity: 0.6 });
      [[-0.12, -0.12], [0.12, -0.12], [-0.12, 0.12], [0.12, 0.12]].forEach(([x, y]) => {
        const prop = new THREE.Mesh(propGeom, propMat);
        prop.position.set(x, y, 0.05);
        droneModel.add(prop);
      });

      scene.add(droneModel);
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);

      // 计算FPS
      fpsFrameCount++;
      const now = Date.now();
      if (now - lastFpsTime >= 1000) {
        document.getElementById('fps').textContent = fpsFrameCount;
        fpsFrameCount = 0;
        lastFpsTime = now;
      }
    }

    // WebSocket 连接
    function connectWebSocket() {
      ws = new WebSocket(WS_URL);

      ws.onopen = () => {
        document.getElementById('status').className = 'connected';
        document.getElementById('status').textContent = '已连接';
        console.log('WebSocket 已连接');
      };

      ws.onclose = () => {
        document.getElementById('status').className = 'disconnected';
        document.getElementById('status').textContent = '已断开';
        console.log('WebSocket 已断开，5秒后重连...');
        setTimeout(connectWebSocket, 5000);
      };

      ws.onerror = (err) => {
        console.error('WebSocket 错误:', err);
      };

      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          handleMessage(msg);
        } catch (e) {
          console.error('消息解析错误:', e);
        }
      };
    }

    function handleMessage(msg) {
      if (msg.type === 'mqtt_message') {
        const { topic, data } = msg;

        // 点云数据
        if ((topic === '/daf/pointcloud' || topic === '/daf/pointcloud_rgb') && !isPaused) {
          if (data.points && data.points.length > 0) {
            addPoints(data.points);
            frameCount++;
            document.getElementById('frameCount').textContent = frameCount;
          }
        }

        // 位姿数据
        if (topic === '/daf/local/odometry') {
          updateDronePosition(data);
        }
      }
    }

    function addPoints(newPoints) {
      // 检查是否超过最大点数
      if (totalPoints >= MAX_POINTS) return;

      const availableSpace = MAX_POINTS - totalPoints;
      const pointsToAdd = newPoints.slice(0, availableSpace);

      pointsToAdd.forEach(point => {
        const x = point.xyz?.x ?? 0;
        const y = point.xyz?.y ?? 0;
        const z = point.xyz?.z ?? 0;
        const intensity = (point.intensity ?? 128) / 255;

        positions.push(x, y, z);
        colors.push(intensity, 0.5, 1 - intensity);
      });

      totalPoints += pointsToAdd.length;
      document.getElementById('totalPoints').textContent = totalPoints.toLocaleString();

      // 更新几何体
      pointGeometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
      pointGeometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
      pointGeometry.computeBoundingSphere();
    }

    function updateDronePosition(data) {
      const pos = data.pose?.position || data.position;
      const ori = data.pose?.orientation || data.orientation;

      if (pos && droneModel) {
        droneModel.position.set(pos.x, pos.y, pos.z);
        document.getElementById('dronePos').textContent =
          `(${pos.x.toFixed(2)}, ${pos.y.toFixed(2)}, ${pos.z.toFixed(2)})`;
      }

      if (ori && droneModel) {
        const quat = new THREE.Quaternion(ori.x, ori.y, ori.z, ori.w);
        droneModel.setRotationFromQuaternion(quat);
      }
    }

    function clearPoints() {
      positions = [];
      colors = [];
      totalPoints = 0;
      frameCount = 0;
      pointGeometry.setAttribute('position', new THREE.Float32BufferAttribute([], 3));
      pointGeometry.setAttribute('color', new THREE.Float32BufferAttribute([], 3));
      document.getElementById('totalPoints').textContent = '0';
      document.getElementById('frameCount').textContent = '0';
    }

    // 事件绑定
    document.getElementById('pauseBtn').addEventListener('click', function() {
      isPaused = !isPaused;
      this.textContent = isPaused ? '继续' : '暂停';
    });

    document.getElementById('clearBtn').addEventListener('click', clearPoints);

    // 初始化
    initThree();
    connectWebSocket();
  </script>
</body>
</html>
