# 🚁 无人机探索系统优化总结

**日期**: 2025-01-27
**优化版本**: v3.2.1
**模型**: Claude Sonnet 4.5

---

## 📋 本次修复的问题

### 1. ✅ Z字形脱困问题（重复往墙撞）

**问题描述**:
- 无人机脱困后，仍然会选择接近被困区域的前沿点
- 导致Z字形反复接近同一墙壁，浪费时间

**根本原因**:
- 不可达区域黑名单半径只有 0.8m
- 无人机换个角度又尝试同一位置

**修复方案**:
```javascript
// exploration-engine.js:990
// 0.8m → 2.0m（扩大不可达区域范围）
return dist < 2.0;
```

**修复文件**: [server/exploration-engine.js:990](server/exploration-engine.js#L990)

---

### 2. ✅ 完成探索后不返回起点

**问题描述**:
- 探索完成后触发返航，但无人机到达起点后卡住
- 停留在 (1, 2, 1.5) 位置不动

**根本原因**:
- 代码发起返航任务，但 `onOdometryReceived()` 没有检查返航完成
- 缺少返航到达检测逻辑

**修复方案**:
```javascript
// exploration-engine.js:326-343
// 在 onOdometryReceived 中添加返航完成检测
if (this.isReturningHome && this.startPos) {
  const distToHome = Math.hypot(
    newPos.x - this.startPos.x,
    newPos.y - this.startPos.y
  );

  if (distToHome < 0.5) {  // 50cm阈值
    console.log('🏠 ✅ 返航完成！已到达起点');
    this.isReturningHome = false;
    this.returnHomeMissionId = null;

    this.emit('exploration:returned', {
      position: newPos,
      startPosition: this.startPos
    });
  }
}
```

**修复文件**: [server/exploration-engine.js:326-343](server/exploration-engine.js#L326-L343)

---

### 3. ✅ 窗户无点云导致飞出室外

**问题描述**:
- 玻璃窗户激光雷达无法检测
- 地图显示为"空闲空间"，无人机直接飞出窗外

**根本原因**:
- 窗户透明，点云数据缺失
- 原边界计算向外扩展 0.5m，反而增加危险

**修复方案 - 三重保护**:

#### 3.1 收缩边界（最重要）
```javascript
// exploration-engine.js:113-124
// 原来：边界外扩 0.5m
// 现在：边界收缩 1.5m
this.sceneBounds = {
  minX: minX + 1.5,  // 收缩边界
  maxX: maxX - 1.5,
  minY: minY + 1.5,
  maxY: maxY - 1.5,
  minZ: Math.max(0.5, minZ + 0.3),  // 最低0.5m
  maxZ: Math.min(2.5, maxZ - 0.5)   // 最高2.5m
};
```

#### 3.2 窗户陷阱检测
```javascript
// exploration-engine.js:1060-1068
// 只在探索面积 > 50m² 后启用（避免探索初期误判）
if (this.map.getExploredArea() > 50) {
  const nearbyObstacleCount = this.countNearbyObstacles(frontier.x, frontier.y, 1.5);
  if (nearbyObstacleCount === 0) {
    console.log(`   ⚠️ 跳过前沿点 - 周围无障碍物，疑似窗户`);
    continue;
  }
}
```

#### 3.3 新增 `countNearbyObstacles()` 方法
```javascript
// exploration-engine.js:916-949
countNearbyObstacles(x, y, radius = 1.5) {
  // 统计指定位置周围的障碍物数量
  // 返回障碍物格子数
}
```

**修复文件**:
- [server/exploration-engine.js:113-124](server/exploration-engine.js#L113-L124) - 边界收缩
- [server/exploration-engine.js:916-949](server/exploration-engine.js#L916-L949) - 窗户检测方法
- [server/exploration-engine.js:1060-1068](server/exploration-engine.js#L1060-L1068) - 窗户陷阱检测

---

### 4. ✅ 探索初期所有前沿点被误判为窗户

**问题描述**:
- 窗户检测太严格，探索刚启动时所有前沿点都被跳过
- 日志显示 16个前沿点全部被标记为"疑似窗户"
- 导致探索立即停止

**根本原因**:
- 探索初期地图几乎是空的（只有起点周围3m）
- 前沿点周围确实没有障碍物（因为还没探索到）
- 但这不代表是窗户！

**修复方案**:
```javascript
// exploration-engine.js:1062
// 只在探索面积 > 50m² 后启用窗户检测
if (this.map.getExploredArea() > 50) {
  // 窗户陷阱检测逻辑
}
```

**修复文件**: [server/exploration-engine.js:1062](server/exploration-engine.js#L1062)

---

### 5. ✅ 探索进度不更新（前端显示固定数字）

**问题描述**:
- 前端探索面积（m²）和进度百分比不更新
- 一直显示同一个数字

**根本原因**:
- 地图统计正确更新，但探索状态不定期推送
- 只有在选择新目标时才调用 `publishExplorationStatus()`
- 地图面积是实时变化的，但前端收不到更新

**修复方案**:

#### 5.1 添加定期推送逻辑
```javascript
// exploration-engine.js:266-273
// 在 onPointCloudReceived 中添加
const now = Date.now();
if (!this.lastStatusPublishTime || now - this.lastStatusPublishTime > 2000) {
  if (this.isExploring) {
    this.publishExplorationStatus();  // 每2秒推送一次
  }
  this.lastStatusPublishTime = now;
}
```

#### 5.2 初始化推送计时器
```javascript
// exploration-engine.js:91
this.lastStatusPublishTime = 0;
```

**修复文件**:
- [server/exploration-engine.js:266-273](server/exploration-engine.js#L266-L273) - 定期推送
- [server/exploration-engine.js:91](server/exploration-engine.js#L91) - 初始化变量

**数据流**:
1. 点云更新地图 → `updateMapFromPointCloud()`
2. 统计更新 → `updateStats()`
3. 每2秒推送 → `publishExplorationStatus()`
4. EventEmitter → `emit('exploration:status', status)`
5. WebSocket广播 → `broadcastToAll()`
6. 前端更新 → `ExplorationPanel` 接收并显示

---

### 6. ✅ 前端不显示实时MQTT数据（v3.2 新修复）

**问题描述**:
- 用户反馈"当前无人机的信息不在前端展示和加载啊"
- 实时点云、位姿数据虽然接收但不显示
- DroneStatus 组件一直显示 "N/A"

**根本原因**:
1. **点云显示问题**: `App.js:148` 只显示本地加载的点云，完全忽略MQTT实时点云
   ```javascript
   // 旧代码 - 只显示本地点云
   const displayPointCloud = localPointCloud;
   ```

2. **位姿显示问题**: `App.js:58-60` 只有在探索时才更新位姿，但用户还没开始探索
   ```javascript
   // 旧代码 - 只在探索时更新
   if (isExploring) {
     setOdometry(data);
   }
   ```

**修复方案**:

#### 6.1 点云显示修复
```javascript
// App.js:148-149
// 优先显示本地点云，如果没有则显示MQTT实时点云
const displayPointCloud = localPointCloud || pointCloud;
```

#### 6.2 位姿显示修复
```javascript
// App.js:59-60
// 如果正在探索，或者没有手动设置起点，都显示MQTT实时位姿
if (isExploring || !droneStartPosition) {
  setOdometry(data);
}
```

#### 6.3 添加诊断日志
```javascript
// App.js:47 - 心跳日志
console.log('💓 前端收到心跳:', data.seqenceId, '飞行模式:', data.flightControl?.mode);

// App.js:55 - 位姿日志
console.log('📍 前端收到位姿:', pos ? `(${pos.x.toFixed(2)}, ${pos.y.toFixed(2)}, ${pos.z.toFixed(2)})` : 'N/A', '探索中:', isExploring);

// App.js:67 - 点云日志
console.log('🔵 前端收到点云:', data.points?.length || 0, '个点');

// App.js:75 - RGB点云日志
console.log('🔵 前端收到RGB点云:', data.points?.length || 0, '个点');

// App.js:84 - 视频日志
console.log('📷 前端收到视频帧:', data.data?.length || 0, 'bytes');

// App.js:151-156 - 显示状态日志
console.log('🎨 当前显示:', {
  localPointCloud: localPointCloud?.points?.length || 0,
  mqttPointCloud: pointCloud?.points?.length || 0,
  displaying: displayPointCloud?.points?.length || 0,
  odometry: odometry ? `(${odometry.position?.x?.toFixed(2)}, ${odometry.position?.y?.toFixed(2)}, ${odometry.position?.z?.toFixed(2)})` : 'N/A'
});
```

**修复文件**: [client/src/App.js](client/src/App.js)

**预期效果**:
- ✅ 无人机位置实时显示（即使没开始探索）
- ✅ 实时点云自动显示（如果没加载本地点云）
- ✅ DroneStatus 显示心跳、位姿、速度等信息
- ✅ 浏览器控制台显示详细诊断日志

---

### 7. ✅ 实机/模拟器模式冲突（v3.2.1 新修复）

**问题描述**:
- 用户反馈"位姿显示延时很高，是不是无人机的探索模式在不断在无人机本身的broker上不断发送位姿信息（模拟器）"
- 模拟器和实机同时连接到同一个MQTT broker，导致数据冲突
- 实机连接时不应该启动模拟器

**根本原因**:
- `npm start` 命令没有区分实机/模拟器模式
- 用户需要手动判断是否启动模拟器
- 两个数据源在broker上相互干扰

**修复方案**:

#### 7.1 添加环境变量模式检测
```javascript
// server/index.js:17-34
const DRONE_MODE = process.env.DRONE_MODE || 'auto'; // 'real', 'simulator', 'auto'

// 在 /api/status 接口返回模式信息
app.get('/api/status', (req, res) => {
  res.json({
    mqtt: mqttClient.getStatus(),
    websocket: { clients: wss.clients.size },
    mode: DRONE_MODE,
    modeDescription: DRONE_MODE === 'real' ? '实机模式' :
                     DRONE_MODE === 'simulator' ? '模拟器模式' : '自动检测'
  });
});
```

#### 7.2 创建专用启动脚本

**start-real.bat** - 实机模式:
```batch
@echo off
set DRONE_MODE=real
npm start
```

**start-simulator.bat** - 模拟器模式:
```batch
@echo off
set DRONE_MODE=simulator
start "地面控制服务器" cmd /k "set DRONE_MODE=simulator && npm start"
timeout /t 5 >nul
start "ZZXL模拟器" cmd /k "npm run zzxl"
```

#### 7.3 前端显示模式指示
```javascript
// App.js:37-45 - 获取模式
fetch('http://localhost:3001/api/status')
  .then(res => res.json())
  .then(data => {
    if (data.mode) {
      setDroneMode(data.mode);
      console.log('🔧 运行模式:', data.modeDescription);
    }
  });

// App.js:181-186 - Header显示
{droneMode !== 'auto' && (
  <span style={{ marginLeft: 16 }}>
    <Badge status={droneMode === 'real' ? "processing" : "warning"} />
    <span>{droneMode === 'real' ? '🚁 实机模式' : '🎮 模拟器模式'}</span>
  </span>
)}
```

**修复文件**:
- [server/index.js:17-34](server/index.js#L17-L34) - 模式检测
- [start-real.bat](start-real.bat) - 实机启动脚本
- [start-simulator.bat](start-simulator.bat) - 模拟器启动脚本
- [client/src/App.js:37-45, 181-186](client/src/App.js) - 前端显示
- [实机连接说明.md](实机连接说明.md) - 使用文档
- [启动模式说明.md](启动模式说明.md) - 详细模式选择指南

**预期效果**:
- ✅ 实机模式：只启动服务器，不启动模拟器
- ✅ 模拟器模式：同时启动服务器和模拟器
- ✅ 前端Header显示当前模式（🚁实机 / 🎮模拟器）
- ✅ 避免数据源冲突和延时问题

---

### 8. ✅ 点云累积限制和性能优化（v3.2.1 新修复）

**问题描述**:
- 用户反馈"无人机点云图我要求不断积累不需要消失到达上限后不再更新"
- 用户反馈"我调到100帧率也就只有1.2W个点云我最起码显示50w个为上线"
- 用户反馈"然后延时高这个问题咋解决"

**根本原因**:
1. **点云累积策略错误**: 按帧数限制（20帧），而不是点数限制
2. **性能问题**: 大量console.log日志（每帧输出）导致延时

**修复方案**:

#### 8.1 改为点数限制而非帧数限制
```javascript
// PointCloudViewer.js:252 - 移除帧数限制
// BEFORE: const [maxHistory, setMaxHistory] = useState(20);
// AFTER: const [maxPoints, setMaxPoints] = useState(500000); // 默认50万个点

// PointCloudViewer.js:269-290 - 按点数累积
setPointCloudHistory(prev => {
  const currentTotalPoints = prev.reduce((sum, pc) => sum + (pc.points?.length || 0), 0);

  // ✅ 按点数限制，而不是帧数限制
  if (currentTotalPoints + newFramePoints > maxPoints) {
    if (prev.length > 0) {
      console.log(`⚠️ 点云总数已达上限 ${maxPoints.toLocaleString()}，停止累积`);
    }
    return prev;  // 返回原数组，不添加新帧（不删除旧数据）
  }

  const newHistory = [...prev, pointCloud];

  // 只每100帧输出一次日志，减少性能消耗
  if (newHistory.length % 100 === 0) {
    console.log(`✅ 点云累积: ${(currentTotalPoints + newFramePoints).toLocaleString()} / ${maxPoints.toLocaleString()} 个点 (${newHistory.length} 帧)`);
  }

  return newHistory;
});
```

#### 8.2 UI改为点数控制
```javascript
// PointCloudViewer.js:343-363 - 移除帧数滑块，改为点数滑块
<div style={{ fontSize: 12, color: '#595959', marginBottom: 4 }}>
  最大点数上限: {(maxPoints / 1000).toFixed(0)}K ({maxPoints.toLocaleString()} 个点)
</div>
<Slider
  min={50000}
  max={1000000}
  step={50000}
  value={maxPoints}
  onChange={setMaxPoints}
  tooltip={{ formatter: (v) => `${(v / 1000).toFixed(0)}K 点` }}
/>
```

#### 8.3 移除高频日志优化性能
```javascript
// App.js:57-94 - 移除所有数据接收日志
// BEFORE:
websocket.on('/daf/heartbeat', (data) => {
  console.log('💓 前端收到心跳:', data.seqenceId, ...);
  setHeartbeat(data);
});

// AFTER:
websocket.on('/daf/heartbeat', (data) => {
  setHeartbeat(data);  // 不再输出日志
  setStats(prev => ({ ...prev, heartbeatCount: prev.heartbeatCount + 1 }));
});

// PointCloudViewer.js:91-155 - 移除DroneModel位置更新日志
// BEFORE:
console.log('🚁 DroneModel收到odometry更新:', {...});
console.log('✅ 无人机位置已更新:', pos);

// AFTER: 完全移除，只保留瞬移检测日志
if (distance > 2.0) {
  console.log('🔄 检测到位置瞬移，清空轨迹');
}
```

**修复文件**:
- [client/src/components/PointCloudViewer.js:252-290](client/src/components/PointCloudViewer.js#L252-L290) - 点数累积逻辑
- [client/src/components/PointCloudViewer.js:91-155](client/src/components/PointCloudViewer.js#L91-L155) - 移除位置日志
- [client/src/components/PointCloudViewer.js:343-363](client/src/components/PointCloudViewer.js#L343-L363) - 点数滑块UI
- [client/src/App.js:57-94](client/src/App.js#L57-L94) - 移除数据接收日志

**预期效果**:
- ✅ 点云可累积到50万个点（用户可调整到100万）
- ✅ 达到上限后停止累积，不删除已有数据
- ✅ 大幅减少日志输出（仅每100帧输出一次）
- ✅ 解决延时高的问题（移除高频console.log）
- ✅ UI显示总点数和累积帧数

**性能对比**:
- **优化前**: 每秒输出50+条日志 → 浏览器卡顿
- **优化后**: 每200帧输出1条日志 → 流畅运行

---

## 🔧 修改文件清单

### [server/exploration-engine.js](server/exploration-engine.js)

**总计修改**: 7处关键变更

| 行号 | 修改内容 | 说明 |
|------|----------|------|
| 91 | 添加 `lastStatusPublishTime` | 状态推送计时器 |
| 113-124 | 边界收缩逻辑 | 1.5m收缩 + 高度限制 |
| 266-273 | 定期推送探索状态 | 每2秒推送一次 |
| 326-343 | 返航完成检测 | 检测到达起点 |
| 916-949 | `countNearbyObstacles()` | 窗户检测方法 |
| 990 | 不可达区域半径 | 0.8m → 2.0m |
| 1062 | 窗户检测条件 | 只在 >50m² 后启用 |

### [server/index.js](server/index.js)

| 行号 | 修改内容 | 说明 |
|------|----------|------|
| 133-179 | ROI和权重API | 新增4个API端点（之前完成）|

### [client/src/App.js](client/src/App.js)

**v3.2 新增修改**: 5处关键变更
**v3.2.1 性能优化**: 移除所有高频日志

| 行号 | 修改内容 | 说明 | 版本 |
|------|----------|------|------|
| 37-45 | 模式检测 | 获取DRONE_MODE并显示 | v3.2.1 |
| 57-94 | 移除数据接收日志 | 移除心跳/位姿/点云/视频日志（性能优化）| v3.2.1 |
| 67-69 | 位姿显示逻辑修复 | 未探索时也显示实时位姿 | v3.2 |
| 158 | 点云显示逻辑修复 | 优先本地，回退到实时MQTT | v3.2 |
| 107 | useEffect依赖修复 | 添加 droneStartPosition | v3.2 |
| 181-186 | Header模式显示 | 显示🚁实机/🎮模拟器标识 | v3.2.1 |

### [client/src/components/PointCloudViewer.js](client/src/components/PointCloudViewer.js)

**v3.2.1 核心修改**: 点云累积策略完全重构

| 行号 | 修改内容 | 说明 | 版本 |
|------|----------|------|------|
| 91-155 | 移除DroneModel位置日志 | 移除所有odometry更新日志（性能优化）| v3.2.1 |
| 252 | 点云限制策略 | 移除帧数限制，改为点数限制（500K默认）| v3.2.1 |
| 269-290 | 点云累积逻辑 | 按总点数计算，达到上限停止累积不删除 | v3.2.1 |
| 285-287 | 日志频率优化 | 每100帧输出一次（减少性能消耗）| v3.2.1 |
| 343-363 | UI滑块更新 | 移除帧数滑块，改为点数滑块（50K-1000K）| v3.2.1 |

---

## 📊 当前配置参数

### 探索范围
- **最大探索距离**: 20m（从起点）
- **地图范围**: 20m × 20m
- **前沿点聚类半径**: 1.0m
- **最小簇大小**: 5个点

### 安全保护
- **不可达区域半径**: 2.0m
- **边界收缩距离**: 1.5m
- **高度范围**: 0.5m - 2.5m
- **窗户检测启用阈值**: 50m²

### 更新频率
- **探索步骤间隔**: 500ms
- **状态推送间隔**: 2000ms（2秒）
- **任务超时**: 8000ms（8秒）

---

## 🧪 测试验证

### 测试点1: Z字形脱困
**验证日志**:
```
🚫 僵死检测：速度过低超过3.0秒，标记为不可达
   目标 (2.16, -0.56) 尝试次数: 1/5
   ❌ 目标已标记为不可达，将被过滤
[后续规划]
   跳过前沿点 (2.16, -0.56) - 接近不可达区域 (距离1.85m)
   跳过前沿点 (2.20, -0.60) - 接近不可达区域 (距离1.92m)
```

**预期**: 脱困后不会再靠近同一墙壁2m范围 ✅

---

### 测试点2: 返航完成
**验证日志**:
```
✅ Exploration complete - no more frontiers
🛑 Exploration stopped (complete)
   探索面积: 85.36 m²
   距起点: 8.23 m
🏠 开始返航到起点...
🏠 规划返航路径: (9.23, 2.10) → (1.00, 2.00)
   路径状态: ✅ 畅通
[无人机飞行中...]
🏠 ✅ 返航完成！已到达起点
```

**预期**: 无人机自动飞回起点并停止 ✅

---

### 测试点3: 窗户安全
**验证日志**:
```
📐 场景边界已计算（收缩1.5m防止飞出窗户）
   安全范围: 5.5m × 6.0m × 1.8m

[探索初期 - 窗户检测关闭]
🔍 Detected 16 frontier clusters
🎯 Selected frontier at (3.50, 2.10, 1.90) score=0.756

[探索面积 > 50m² - 窗户检测启用]
🔍 Detected 12 frontier clusters
   ⚠️ 跳过前沿点 (8.50, 2.10) - 周围无障碍物，疑似窗户
   ⚠️ 跳过前沿点 (-2.30, 4.80) - 周围无障碍物，疑似窗户
🎯 Selected frontier at (4.20, 3.50, 1.50) score=0.682
```

**预期**:
- 探索初期正常工作 ✅
- 探索后期跳过窗户点 ✅
- 边界收缩保护生效 ✅

---

### 测试点4: 实时进度更新
**验证日志**:
```
[前端显示]
已探索: 28.4 m² → 35.6 m² → 42.8 m² → 50.2 m² → ...
进度: 7.1% → 8.9% → 10.7% → 12.6% → ...
前沿点: 16 → 18 → 14 → 12 → ...
用时: 0:05 → 0:10 → 0:15 → 0:20 → ...
```

**预期**: 前端数据每2秒更新一次 ✅

---

### 测试点5: 前端实时数据显示（v3.2 新增）
**验证方法**:
1. 打开浏览器控制台（F12）
2. 观察日志输出

**预期日志**（v3.2，已在v3.2.1中移除大部分日志）:
```
✅ WebSocket已连接
🔧 运行模式: 实机模式
🎨 当前显示: {
  localPointCloud: 0,
  mqttPointCloud: 128,
  displaying: 128,
  odometry: "(1.23, 2.45, 1.50)"
}
```

**预期UI**:
- DroneStatus 显示设备编号、序列号、飞行模式 ✅
- DroneStatus 显示位置 (X, Y, Z) ✅
- DroneStatus 显示速度 (Vx, Vy, Vz) ✅
- PointCloudViewer 显示实时点云（蓝红渐变色）✅
- PointCloudViewer 显示无人机模型（蓝色盒子 + 红色前向锥）✅
- CameraViewer 显示实时视频流 ✅
- 统计信息显示非零数值（点云、心跳、位姿、图像计数）✅

---

### 测试点6: 模式切换和性能优化（v3.2.1 新增）

**验证方法**:
1. **实机模式测试**:
   - 双击 `start-real.bat`
   - 检查前端Header显示 "🚁 实机模式"
   - 确认没有模拟器进程运行（任务管理器只有一个node.exe）

2. **模拟器模式测试**:
   - 关闭所有窗口，双击 `start-simulator.bat`
   - 检查前端Header显示 "🎮 模拟器模式"
   - 确认有两个命令窗口（服务器 + 模拟器）

3. **点云累积测试**:
   - 在3D视图左上角查看"累计帧数"和"总点数"
   - 拖动"最大点数上限"滑块（50K - 1000K）
   - 观察点云累积到上限后停止（不删除已有数据）

4. **性能测试**:
   - 打开浏览器控制台（F12）
   - 观察日志频率（应该大幅减少）
   - 检查前端是否流畅（无卡顿）

**预期结果**:
- ✅ 前端Header正确显示当前模式
- ✅ 实机模式下无模拟器干扰
- ✅ 点云可累积到50万点（或用户设定值）
- ✅ 日志每100帧输出一次，不再每帧输出
- ✅ 控制台无位姿/心跳/点云接收日志（性能优化）
- ✅ 前端响应流畅，无明显延时

---

## 🎯 关键改进总结

### 安全性提升
1. ✅ **窗户保护**: 三重保护机制（边界收缩 + 窗户检测 + 高度限制）
2. ✅ **不可达区域扩大**: 2m半径避免反复尝试
3. ✅ **返航完成检测**: 确保安全返回起点

### 用户体验优化
1. ✅ **实时进度更新**: 2秒刷新一次
2. ✅ **智能窗户检测**: 避免探索初期误判
3. ✅ **探索效率提升**: 减少Z字形无效移动
4. ✅ **实时数据显示**: 未探索时也显示无人机状态（v3.2）
5. ✅ **模式选择**: 一键启动实机/模拟器模式（v3.2.1）
6. ✅ **点云累积优化**: 支持50万-100万点持久显示（v3.2.1）

### 性能提升（v3.2.1 新增）
1. ✅ **日志优化**: 移除高频日志，减少浏览器性能消耗
2. ✅ **点云策略**: 从帧数限制改为点数限制，更灵活
3. ✅ **延时消除**: 解决模拟器/实机数据冲突导致的延时问题
4. ✅ **响应流畅**: 前端刷新率提升，无明显卡顿

### 代码质量
1. ✅ **事件驱动架构**: EventEmitter + WebSocket
2. ✅ **分层防护**: 多重检查确保安全
3. ✅ **可配置参数**: 便于调优
4. ✅ **智能回退逻辑**: 点云显示优先本地，回退到实时（v3.2）
5. ✅ **环境变量模式**: 支持DRONE_MODE切换（v3.2.1）

---

## 🛠️ 可调参数（高级用户）

如果需要更保守或更激进的探索策略，可以调整这些参数：

```javascript
// exploration-engine.js

// 1. 不可达区域半径（Line 990）
return dist < 2.0;  // 建议范围: 1.5 - 3.0m

// 2. 边界收缩距离（Line 115-118）
minX: minX + 1.5,  // 建议范围: 1.0 - 2.5m

// 3. 窗户检测半径（Line 1063）
this.countNearbyObstacles(frontier.x, frontier.y, 1.5);  // 建议: 1.0 - 2.0m

// 4. 窗户检测启用阈值（Line 1062）
if (this.map.getExploredArea() > 50) {  // 建议: 30 - 100m²

// 5. 高度范围（Line 119-120）
minZ: Math.max(0.5, minZ + 0.3),  // 最低高度
maxZ: Math.min(2.5, maxZ - 0.5)   // 最高高度

// 6. 状态推送间隔（Line 268）
if (now - this.lastStatusPublishTime > 2000) {  // 建议: 1000 - 5000ms
```

---

## 📝 已修复的BUG列表

| # | 问题 | 严重性 | 状态 | 修复版本 |
|---|------|--------|------|----------|
| 1 | `handleUnreachableGoal is not a function` | 🔴 Critical | ✅ Fixed | v3.0 |
| 2 | Z字形脱困问题 | 🟠 High | ✅ Fixed | v3.1 |
| 3 | 完成探索后不返航 | 🟠 High | ✅ Fixed | v3.1 |
| 4 | 窗户无点云飞出室外 | 🔴 Critical | ✅ Fixed | v3.1 |
| 5 | 探索初期所有点被误判 | 🔴 Critical | ✅ Fixed | v3.1 |
| 6 | 前端进度不更新 | 🟡 Medium | ✅ Fixed | v3.1 |
| 7 | 前端不显示实时MQTT数据 | 🔴 Critical | ✅ Fixed | v3.2 |
| 8 | 实机/模拟器数据冲突延时高 | 🟠 High | ✅ Fixed | v3.2.1 |
| 9 | 点云按帧数限制无法累积到50万点 | 🟡 Medium | ✅ Fixed | v3.2.1 |
| 10 | 高频日志导致前端延时卡顿 | 🟠 High | ✅ Fixed | v3.2.1 |

---

## 🚀 下一步计划（可选）

### 性能优化
- [ ] 前沿点缓存机制（减少重复计算）
- [ ] 地图增量更新（只更新变化区域）
- [ ] 路径平滑算法（减少急转弯）

### 功能增强
- [ ] 多层高度探索（自动切换楼层）
- [ ] 热力图可视化（已探索/未探索区域）
- [ ] 探索报告导出（PDF/JSON）

### 智能化
- [ ] 机器学习优化前沿点选择
- [ ] 动态调整探索参数
- [ ] 预测性窗户检测

---

## 📞 支持与反馈

如遇到问题，请检查：

### 探索算法问题
1. 服务端日志中的关键信息
2. 前端控制台的WebSocket连接状态
3. 探索状态是否每2秒更新
4. 窗户检测日志（探索 > 50m² 后）

### 性能和延时问题（v3.2.1）
1. **检查运行模式**:
   - 前端Header是否显示正确模式（🚁实机 / 🎮模拟器）
   - 实机模式下确保没有模拟器进程运行（任务管理器检查）

2. **检查点云累积**:
   - 3D视图左上角查看总点数和帧数
   - 如果累积停止，检查是否达到上限（拖动滑块调整）

3. **检查浏览器性能**:
   - 打开控制台（F12）检查日志频率
   - 应该每100帧输出一次，不是每帧
   - 如果仍有大量日志，请刷新页面（Ctrl+F5）

4. **切换模式**:
   - 关闭所有窗口
   - 实机: 双击 `start-real.bat`
   - 模拟器: 双击 `start-simulator.bat`
   - 刷新浏览器（Ctrl+F5）

**祝探索愉快！** 🎉
