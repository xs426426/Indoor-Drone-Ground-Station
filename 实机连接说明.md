# 🚁 实机连接与模拟器切换说明

## ⚠️ 重要：模拟器会覆盖实机位姿数据

### 问题原因

当**模拟器**和**实机**同时连接到同一个MQTT broker时：

- **模拟器**发布位姿到 `/daf/local/odometry`
- **实机**也发布位姿到 `/daf/local/odometry`
- **后端服务器**同时接收两个数据源，导致数据混乱和延时

## 🔧 解决方案：停止模拟器

### 方案1: 使用实机时完全停止模拟器

**步骤**:

1. **查找模拟器进程**:
   ```bash
   # Windows
   tasklist | findstr node

   # 找到运行 zzxl-simulator.js 或 simulator.js 的进程
   ```

2. **停止模拟器进程**:
   ```bash
   # 如果模拟器在单独的终端运行
   # 切换到那个终端，按 Ctrl+C

   # 或者强制结束进程
   taskkill /F /IM node.exe /FI "WINDOWTITLE eq zzxl*"
   ```

3. **验证模拟器已停止**:
   - 后端日志不再显示模拟器相关的日志
   - 浏览器控制台位姿日志显示实机真实坐标

---

### 方案2: 修改配置使用不同的MQTT broker

**原理**: 模拟器和实机使用不同的MQTT broker，互不干扰

**实机配置** (使用真实无人机的broker):
```javascript
// server/config.js
module.exports = {
  mqtt: {
    broker: '192.168.1.100',  // 实机无人机的IP
    port: 1883,
    clientId: 'ground_control_real'
  },
  // ...
};
```

**模拟器配置** (使用本地broker):
```bash
# 启动模拟器时指定不同的broker
node server/zzxl-simulator.js mqtt://127.0.0.1:1883
```

---

### 方案3: 使用环境变量控制启动模式

**创建启动脚本**:

**实机模式** (`start-real.bat`):
```batch
@echo off
echo 🚁 启动实机模式（不启动模拟器）
cd server
set MODE=REAL
npm start
```

**模拟器模式** (`start-simulator.bat`):
```batch
@echo off
echo 🎮 启动模拟器模式
start "后端服务器" cmd /k "cd server && npm start"
timeout /t 3
start "模拟器" cmd /k "cd server && node zzxl-simulator.js"
```

---

## ✅ 当前已修复的问题

### 1. 点云累积逻辑修复

**旧逻辑** (PointCloudViewer.js):
```javascript
// 达到上限后删除旧帧，只保留最新N帧
if (newHistory.length > maxHistory) {
  return newHistory.slice(newHistory.length - maxHistory);
}
```

**新逻辑** (已修复):
```javascript
// ✅ 达到上限后停止累积，保留所有旧帧
if (newHistory.length > maxHistory) {
  console.log(`⚠️ 点云帧数已达上限 ${maxHistory}，停止累积`);
  return prev;  // 不添加新帧，保留所有已有帧
}
```

**效果**:
- 点云持续累积，直到达到设定的帧数上限（默认20帧）
- 达到上限后不再更新，保留所有已累积的点云
- 用户可以在UI中调整"历史帧数"滑块来控制上限（1-100帧）

---

## 🧪 测试步骤

### 测试1: 验证模拟器已停止

1. 打开浏览器控制台 (F12)
2. 观察位姿日志:
   ```
   📍 前端收到位姿: (x, y, z) 探索中: false
   ```
3. 如果坐标值**频繁变化但无人机未移动** → 模拟器还在运行
4. 如果坐标值**稳定不变或缓慢变化** → 只有实机数据

### 测试2: 验证点云累积

1. 观察控制台日志:
   ```
   添加新点云帧，点数: 128
   添加新点云帧，点数: 132
   ...
   ⚠️ 点云帧数已达上限 20，停止累积
   ```
2. 观察3D视图:
   - 点云逐渐增多（蓝红渐变色的点）
   - 达到上限后点云不再消失
3. 观察左上角统计:
   - "累计帧数" 增加到上限后停止
   - "总点数" 保持不变

---

## 📊 推荐设置

### 实机探索推荐配置

```javascript
// 点云累积设置（在UI中调整）
历史帧数: 100 帧    // 允许累积更多帧
最大点数: 500K 点   // 提高点数上限

// 探索参数
最大探索距离: 20m
探索高度: 1.5m
启用Z轴探索: false  // 实机建议先关闭Z轴
```

### 模拟器测试推荐配置

```javascript
// 点云累积设置
历史帧数: 20 帧
最大点数: 200K 点

// 探索参数
最大探索距离: 20m
探索高度: 1.5m
启用Z轴探索: true
```

---

## 🔍 调试日志说明

### 正常实机日志

```
✅ WebSocket已连接
✅ MQTT 已连接
💓 前端收到心跳: 67890 飞行模式: HOVER
📍 前端收到位姿: (1.23, 2.45, 1.50) 探索中: false
🔵 前端收到点云: 128 个点
🚁 DroneModel收到odometry更新: { hasPosition: true, ... }
✅ 无人机位置已更新: Vector3 {x: 1.23, y: 2.45, z: 1.50}
添加新点云帧，点数: 128
```

### 模拟器干扰日志（异常）

```
📍 前端收到位姿: (0.00, 0.00, 1.00) 探索中: false
📍 前端收到位姿: (0.01, 0.00, 1.00) 探索中: false
📍 前端收到位姿: (0.02, 0.00, 1.00) 探索中: false
// 坐标频繁小幅度变化，但实机未移动
```

---

## 💡 常见问题

### Q1: 无人机位置在3D图中不更新？

**A**: 检查是否有模拟器在运行:
1. 停止所有 `node` 进程
2. 只启动后端服务器: `cd server && npm start`
3. 不启动 `zzxl-simulator.js`

### Q2: 点云累积到20帧后就消失了？

**A**: 已修复！现在点云达到上限后会保留，不会消失。
- 如需更多帧，在UI中拖动"历史帧数"滑块到更大值（如100）

### Q3: 点云显示很慢？

**A**: 降低累积设置:
- 历史帧数: 10-20帧
- 最大点数: 100K-200K点

### Q4: 如何清空累积的点云？

**A**: 点击3D视图左上角的"清空"按钮

---

## 📞 快速参考

| 场景 | 操作 |
|------|------|
| 使用实机 | 停止模拟器，只运行 `npm start` |
| 使用模拟器 | 运行 `npm start` + `node zzxl-simulator.js` |
| 切换到实机 | 按 Ctrl+C 停止模拟器终端 |
| 清空点云 | 点击UI中的"清空"按钮 |
| 调整累积上限 | 拖动"历史帧数"滑块（1-100） |

---

**修改记录**: v3.2.1 - 2025-01-XX
