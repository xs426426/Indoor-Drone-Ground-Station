# 🚁 启动模式选择指南

## 📋 快速启动

### 方式1: 使用实机（推荐）

**双击启动**: `start-real.bat`

或手动执行:
```bash
set DRONE_MODE=real
npm start
```

**特点**:
- ✅ 只启动地面控制服务器
- ✅ 连接真实无人机
- ✅ 不启动模拟器，无数据冲突
- ✅ 前端显示 "🚁 实机模式"

---

### 方式2: 使用模拟器（测试）

**双击启动**: `start-simulator.bat`

或手动执行:
```bash
# 终端1: 启动服务器
set DRONE_MODE=simulator
npm start

# 终端2: 启动模拟器（等3秒后）
npm run zzxl
```

**特点**:
- ✅ 启动服务器 + ZZXL模拟器
- ✅ 使用虚拟点云和位姿数据
- ✅ 适合算法测试
- ✅ 前端显示 "🎮 模拟器模式"

---

## 🎯 模式切换

### 从模拟器切换到实机

1. **关闭所有窗口** (服务器 + 模拟器)
2. **双击 `start-real.bat`**
3. **刷新浏览器页面** (Ctrl+F5)
4. **验证**: 前端右上角显示 "🚁 实机模式"

### 从实机切换到模拟器

1. **关闭服务器窗口**
2. **双击 `start-simulator.bat`**
3. **刷新浏览器页面** (Ctrl+F5)
4. **验证**: 前端右上角显示 "🎮 模拟器模式"

---

## 🔍 模式识别

### 前端显示

**Header右上角状态栏**:
```
✅ 已连接  |  🚁 实机模式    ← 实机
✅ 已连接  |  🎮 模拟器模式   ← 模拟器
✅ 已连接                   ← 自动检测（旧版本）
```

### 浏览器控制台日志

```javascript
// 实机模式
🔧 运行模式: 实机模式

// 模拟器模式
🔧 运行模式: 模拟器模式
```

### 后端API查询

```bash
curl http://localhost:3001/api/status
```

**响应**:
```json
{
  "mqtt": {...},
  "websocket": {...},
  "mode": "real",                  // 'real' 或 'simulator'
  "modeDescription": "实机模式"
}
```

---

## ⚠️ 常见问题

### Q1: 启动实机模式，但前端显示"模拟器模式"？

**原因**: 有模拟器进程在后台运行

**解决**:
```bash
# Windows
tasklist | findstr node
taskkill /F /PID <进程ID>

# 或者重启电脑
```

---

### Q2: 无人机位置延时高/不准确？

**检查**:
1. 是否有模拟器在运行？ → 关闭模拟器
2. 前端是否显示正确模式？ → 刷新页面
3. 浏览器控制台位姿日志是否频繁变化？ → 有模拟器干扰

---

### Q3: 点云累积后不显示了？

**原因**: 达到累积上限（默认20帧）

**解决**: 在3D视图左上角，拖动"历史帧数"滑块到更大值（如100）

---

### Q4: 如何确认模拟器已完全停止？

**验证方法**:
1. 后端日志不再显示模拟器相关输出
2. 前端位姿日志坐标稳定（实机静止时）
3. 任务管理器中只有一个 `node.exe` 进程（服务器）

---

## 📊 文件说明

### 启动脚本

| 文件 | 功能 | 模式 |
|------|------|------|
| `start-real.bat` | 启动实机模式 | `DRONE_MODE=real` |
| `start-simulator.bat` | 启动模拟器模式 | `DRONE_MODE=simulator` |

### 配置文件

| 文件 | 说明 |
|------|------|
| `package.json` | npm脚本配置 |
| `server/config.js` | MQTT配置 |
| `server/index.js` | 服务器入口（支持DRONE_MODE） |

---

## 🎮 NPM命令参考

```bash
# 启动服务器 + 前端（不启动模拟器）
npm start

# 只启动服务器
npm run server

# 只启动前端
npm run client

# 只启动基础模拟器
npm run simulator

# 只启动ZZXL模拟器
npm run zzxl

# 完整测试模式（服务器+前端+模拟器）
npm run test-full
```

---

## 💡 最佳实践

### 开发测试流程

1. **算法开发**: 使用 `start-simulator.bat` 快速测试
2. **真机验证**: 使用 `start-real.bat` 连接实机
3. **调试时**: 查看前端Header确认当前模式
4. **切换前**: 关闭所有终端窗口，避免冲突

### 生产环境

- **始终使用 `start-real.bat`**
- **检查前端显示 "🚁 实机模式"**
- **确保只有一个node进程运行**

---

## 📞 故障排查清单

- [ ] 前端Header是否显示正确模式？
- [ ] 浏览器控制台是否有"运行模式"日志？
- [ ] 是否有多个node进程运行？ (`tasklist | findstr node`)
- [ ] MQTT broker地址是否正确？ (实机IP或127.0.0.1)
- [ ] 是否刷新了浏览器页面？ (Ctrl+F5)

---

**v3.2.1** - 模式选择功能完成
